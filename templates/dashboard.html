<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }} Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            margin: 0;
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #fff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .metric:last-child {
            border-bottom: none;
        }
        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }
        .status-good { color: #4CAF50; }
        .status-warning { color: #FF9800; }
        .status-error { color: #F44336; }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .logs {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
        }
        .refresh-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ app_name }}</h1>
            <p>Real-time System Dashboard v{{ version }}</p>
        </div>

        <div class="dashboard-grid">
            <div class="card" id="performance-card">
                <h3>‚ö° Performance</h3>
                <div id="performance-metrics">
                    <div class="metric">
                        <span>CPU Usage:</span>
                        <span class="metric-value" id="cpu-usage">--</span>
                    </div>
                    <div class="metric">
                        <span>Memory Usage:</span>
                        <span class="metric-value" id="memory-usage">--</span>
                    </div>
                    <div class="metric">
                        <span>GPU Usage:</span>
                        <span class="metric-value" id="gpu-usage">--</span>
                    </div>
                    <div class="metric">
                        <span>Active Time:</span>
                        <span class="metric-value" id="active-time">--</span>
                    </div>
                </div>
            </div>

            <div class="card" id="memory-card">
                <h3>üß† Memory</h3>
                <div id="memory-metrics">
                    <div class="metric">
                        <span>Total Conversations:</span>
                        <span class="metric-value" id="total-conversations">--</span>
                    </div>
                    <div class="metric">
                        <span>Short-term Memory:</span>
                        <span class="metric-value" id="short-term">--</span>
                    </div>
                    <div class="metric">
                        <span>Database Size:</span>
                        <span class="metric-value" id="db-size">--</span>
                    </div>
                    <div class="metric">
                        <span>Uptime:</span>
                        <span class="metric-value" id="uptime">--</span>
                    </div>
                </div>
            </div>

            <div class="card" id="backups-card">
                <h3>üíæ Backups</h3>
                <div id="backups-list">
                    <p>Loading backups...</p>
                </div>
            </div>

            <div class="card" id="controls-card">
                <h3>üéõÔ∏è Controls</h3>
                <div class="controls">
                    <button class="btn" onclick="runCleanup()">üßπ Run Cleanup</button>
                    <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
                    <button class="btn" onclick="exportLogs()">üìÑ Export Logs</button>
                </div>
                <div id="control-status"></div>
            </div>
        </div>

        <div class="card">
            <h3>üìã Recent Logs</h3>
            <div class="logs" id="logs-container">
                <div class="log-entry">Loading logs...</div>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours}h ${minutes}m ${secs}s`;
        }

        function updateStatus(data) {
            // Performance metrics
            document.getElementById('cpu-usage').textContent = `${data.performance.cpu_percent?.toFixed(1) || 'N/A'}%`;
            document.getElementById('memory-usage').textContent = `${data.performance.memory_percent?.toFixed(1) || 'N/A'}%`;
            document.getElementById('gpu-usage').textContent = data.performance.gpu_percent || 'N/A';
            document.getElementById('active-time').textContent = formatTime(data.performance.active_time_seconds || 0);

            // Memory metrics
            document.getElementById('total-conversations').textContent = data.memory.total_conversations || 0;
            document.getElementById('short-term').textContent = data.memory.short_term_count || 0;
            document.getElementById('db-size').textContent = `${data.memory.long_term_size || 0} MB`;
            document.getElementById('uptime').textContent = formatTime(data.uptime || 0);
        }

        function updateBackups(backups) {
            const container = document.getElementById('backups-list');
            if (backups.length === 0) {
                container.innerHTML = '<p>No backups found</p>';
                return;
            }

            let html = '<ul style="list-style: none; padding: 0;">';
            backups.slice(0, 5).forEach(backup => {
                html += `
                    <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <strong>${backup.name}</strong><br>
                        <small>${backup.size_mb} MB ‚Ä¢ ${new Date(backup.created_at).toLocaleDateString()}</small>
                    </li>
                `;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        function updateLogs(logs) {
            const container = document.getElementById('logs-container');
            if (logs.length === 0) {
                container.innerHTML = '<div class="log-entry">No logs found</div>';
                return;
            }

            let html = '';
            logs.slice(0, 10).forEach(log => {
                html += `<div class="log-entry">${log.name} - ${log.size_kb} KB - ${log.modified}</div>`;
            });
            container.innerHTML = html;
        }

        async function refreshData() {
            try {
                // Show refresh indicator
                const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = 'üîÑ Refreshing...';
                refreshBtn.disabled = true;

                // Fetch all data
                const [statusRes, backupsRes, logsRes] = await Promise.all([
                    fetch('/api/status'),
                    fetch('/api/backups'),
                    fetch('/api/logs')
                ]);

                const statusData = await statusRes.json();
                const backupsData = await backupsRes.json();
                const logsData = await logsRes.json();

                updateStatus(statusData);
                updateBackups(backupsData);
                updateLogs(logsData);

                // Reset button
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;

            } catch (error) {
                console.error('Error refreshing data:', error);
                document.getElementById('control-status').innerHTML = '<p style="color: #F44336;">Error refreshing data</p>';
            }
        }

        async function runCleanup() {
            try {
                const response = await fetch('/api/cleanup', { method: 'POST' });
                const result = await response.json();

                document.getElementById('control-status').innerHTML =
                    `<p style="color: #4CAF50;">${result.message || 'Cleanup completed'}</p>`;

                // Refresh data after cleanup
                setTimeout(refreshData, 2000);
            } catch (error) {
                document.getElementById('control-status').innerHTML =
                    '<p style="color: #F44336;">Cleanup failed</p>';
            }
        }

        function exportLogs() {
            // Simple log export - in a real app, this would download files
            alert('Log export feature - check logs directory for exported files');
        }

        // Auto-refresh every 30 seconds
        function startAutoRefresh() {
            refreshInterval = setInterval(refreshData, 30000);
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            startAutoRefresh();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>